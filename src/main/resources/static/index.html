<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html,body { height: 100%; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
          background: #f5f5f5;
          color: #2c3e50;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }

        .hidden { display: none !important; }
        .error { color: #e74c3c; margin: 8px 0; font-size: 14px; }
        .success { color: #27ae60; margin: 8px 0; font-size: 14px; }

        .auth-container {
          max-width: 420px;
          margin: 80px auto;
          padding: 34px;
          background: #fff;
          border-radius: 10px;
          box-shadow: 0 6px 22px rgba(0,0,0,0.06);
        }
        .auth-title { text-align: center; margin-bottom: 18px; font-weight: 400; color: #222; font-size: 22px; }
        .form-group { margin-bottom: 16px; }
        .form-control {
          width: 100%;
          padding: 12px 14px;
          border: 1px solid #e6e6e6;
          border-radius: 8px;
          font-size: 14px;
          background: #fff;
        }
        .form-control:focus { outline: none; border-color: #3aa0ff; box-shadow: 0 0 0 4px rgba(58,160,255,0.06); }
        .btn {
          width: 100%;
          padding: 12px;
          background: #3498db;
          color: #fff;
          border: none;
          border-radius: 8px;
          font-size: 14px;
          cursor: pointer;
        }
        .btn:hover { background: #2c81b8; }
        .toggle-form { text-align: center; margin-top: 12px; }
        .toggle-link { color: #3498db; cursor: pointer; font-size: 14px; text-decoration: none; }

        .logout-btn {
            background: #e74c3c !important;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #c0392b !important;
        }

        .chat-container {
          max-width: 880px;
          margin: 0 auto;
          height: 100vh;
          display: flex;
          flex-direction: column;
          background: #fff;
          border-left: 1px solid #eee;
          border-right: 1px solid #eee;
        }
        .chat-header {
          padding: 20px 24px;
          border-bottom: 1px solid #eee;
          background: #fff;
        }
        .chat-title { font-weight: 400; font-size: 26px; color: #222; }

        /* connecting / status */
        .connecting {
          padding: 10px 20px;
          color: #7f8c8d;
          font-style: italic;
          background: #fafafa;
          border-bottom: 1px solid #f0f0f0;
        }

        .message-area {
          flex: 1 1 auto;
          overflow-y: auto;
          padding: 18px 22px;
          background: #fafafa;
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .message-area li,
        .message-area .message {
          list-style: none;
          width: 100%;
        }

        .event-message {
          text-align: center;
          color: #95a5a6;
          font-style: italic;
          font-size: 13px;
          margin: 8px 0;
        }

        .chat-message {
          display: block;
          width: 100%;
          margin-bottom: 8px;
          padding: 6px 8px;
          border-radius: 8px;
          transition: background .12s ease;
        }

        .message-header {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 6px;
          flex-wrap: nowrap;
        }

        .avatar {
          width: 36px;
          height: 36px;
          border-radius: 50%;
          background: #3498db;
          color: #fff;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          font-size: 14px;
          font-weight: 700;
          flex-shrink: 0;
          box-shadow: 0 1px 0 rgba(0,0,0,0.06);
          text-transform: uppercase;
        }

        .username {
          font-weight: 700;
          color: #16324a;
          font-size: 14px;
          line-height: 1;
        }

        .text {
          display: block;
          margin-left: 46px;   /* aligns text under username (avatar 36px + gap 10px = 46px) */
          margin-top: -24px;   /* pulls text visually under the header line (tweak if needed) */
          padding: 4px 6px;
          color: #34495e;
          font-size: 14px;
          line-height: 1.45;
          word-break: break-word;
        }

           .text { margin-left: 46px; margin-top: 4px; }
           but the negative top gives a compact look similar to many chat apps. */

        .message-header .username {
          max-width: calc(100% - 56px);
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        @media (max-width: 600px) {
          .auth-container { margin: 32px 12px; padding: 20px; }
          .chat-container { max-width: 100%; }
          .avatar { width: 30px; height: 30px; font-size: 13px; }
          .text { margin-left: 40px; }
        }

        .message-form {
          display: flex;
          gap: 10px;
          padding: 14px 18px;
          border-top: 1px solid #eee;
          background: #fff;
          align-items: center;
        }
        .message-input {
          flex: 1 1 auto;
          padding: 12px 14px;
          border-radius: 24px;
          border: 1px solid #e6e6e6;
          font-size: 14px;
          min-width: 0;
        }
        .message-input:focus { outline: none; border-color: #3aa0ff; box-shadow: 0 0 0 4px rgba(58,160,255,0.06); }
        .send-btn {
          padding: 10px 16px;
          border-radius: 24px;
          background: #3498db;
          color: #fff;
          border: none;
          cursor: pointer;
          font-weight: 600;
        }
        .send-btn:hover { background: #2c81b8; }
    </style>
</head>
<body>
<div id="username-page">
    <div class="auth-container">
        <h1 class="auth-title">Chat</h1>

        <form id="usernameForm">
            <div class="form-group">
                <input type="text" id="name" placeholder="Username" autocomplete="off" class="form-control" />
            </div>
            <div class="form-group">
                <input type="password" id="password" placeholder="Password" class="form-control" />
            </div>
            <div class="form-group">
                <button type="submit" class="btn">Login</button>
            </div>
            <div class="toggle-form">
                <a class="toggle-link" id="showRegister">Create account</a>
            </div>
            <div id="login-error" class="error" style="display: none;"></div>
        </form>

        <form id="registerForm" style="display: none;">
            <div class="form-group">
                <input type="text" id="registerName" placeholder="Username" autocomplete="off" class="form-control" />
            </div>
            <div class="form-group">
                <input type="password" id="registerPassword" placeholder="Password" class="form-control" />
            </div>
            <div class="form-group">
                <input type="password" id="confirmPassword" placeholder="Confirm Password" class="form-control" />
            </div>
            <div class="form-group">
                <button type="submit" class="btn">Register</button>
            </div>
            <div class="toggle-form">
                <a class="toggle-link" id="showLogin">Back to login</a>
            </div>
            <div id="register-error" class="error" style="display: none;"></div>
            <div id="register-success" class="success" style="display: none;"></div>
        </form>
    </div>
</div>

<div id="chat-page" class="hidden">
    <div class="chat-container">
        <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h1 class="chat-title">Websocket Chat</h1>
            <button id="logoutBtn" class="logout-btn" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                Logout
            </button>
        </div>
        <div class="connecting">Connecting...</div>
        <div id="messageArea" class="message-area"></div>
        <form id="messageForm" class="message-form">
            <input type="text" id="message" placeholder="Type a message..." autocomplete="off" class="message-input"/>
            <button type="submit" class="send-btn">Send</button>
        </form>
    </div>
</div>

<script>
    'use strict';

    var usernamePage = document.querySelector('#username-page');
    var chatPage = document.querySelector('#chat-page');
    var usernameForm = document.querySelector('#usernameForm');
    var registerForm = document.querySelector('#registerForm');
    var messageForm = document.querySelector('#messageForm');
    var messageInput = document.querySelector('#message');
    var messageArea = document.querySelector('#messageArea');
    var connectingElement = document.querySelector('.connecting');
    var loginError = document.querySelector('#login-error');
    var registerError = document.querySelector('#register-error');
    var registerSuccess = document.querySelector('#register-success');
    var showRegister = document.querySelector('#showRegister');
    var showLogin = document.querySelector('#showLogin');
    var logoutBtn = document.querySelector('#logoutBtn');

    var stompClient = null;
    var username = null;
    var jwtToken = null;

    const BACKEND_URL = 'http://localhost:8080';

    var colors = [
        '#2196F3', '#32c787', '#00BCD4', '#ff5652',
        '#ffc107', '#ff85af', '#FF9800', '#39bbb0'
    ];

    showRegister.addEventListener('click', function() {
        usernameForm.style.display = 'none';
        registerForm.style.display = 'block';
        clearErrors();
    });

    showLogin.addEventListener('click', function() {
        registerForm.style.display = 'none';
        usernameForm.style.display = 'block';
        clearErrors();
    });

    function clearErrors() {
        loginError.style.display = 'none';
        registerError.style.display = 'none';
        registerSuccess.style.display = 'none';
    }

    async function connect(event) {
        event.preventDefault();

        username = document.querySelector('#name').value.trim();
        var password = document.querySelector('#password').value.trim();

        if (!username || !password) {
            showLoginError('Please enter username and password');
            return;
        }

        try {
            console.log('Attempting login for user:', username);

            const response = await fetch(BACKEND_URL + '/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.log('Error response:', errorText);
                throw new Error(errorText || 'Login failed with status: ' + response.status);
            }

            const data = await response.json();
            console.log('Login response data: ', data);

            jwtToken = data.token;
            username = data.user.username;

            console.log('Login successful! Token received for user:', username);

            usernamePage.classList.add('hidden');
            chatPage.classList.remove('hidden');

            // Use full backend URL for WebSocket too
            var socket = new SockJS(BACKEND_URL + '/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, onConnected, onError);

        } catch (error) {
            console.error('Login error:', error);
            showLoginError('Login failed: ' + error.message);
        }
    }

    async function logout() {
    console.log('=== LOGOUT FUNCTION CALLED ===');
    console.log('Current username:', username);
    console.log('JWT Token exists:', !!jwtToken);
    console.log('Stomp Client exists:', !!stompClient);

    try {
        if (!confirm('Are you sure you want to logout?')) {
            console.log('Logout cancelled by user');
            return;
        }

        console.log('Logging out user:', username);

        if (jwtToken) {
            console.log('Sending logout request to backend...');

            const response = await fetch(BACKEND_URL + '/api/auth/logout', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken,
                    'Content-Type': 'application/json'
                }
            });

            console.log('Backend response status:', response.status);

            const responseText = await response.text();
            console.log('Backend response:', responseText);

            if (response.ok) {
                console.log('Backend logout successful');
            } else {
                console.warn('Backend logout failed:', responseText);
            }
        } else {
            console.warn('No JWT token found, skipping backend logout');
        }

        if (stompClient && stompClient.connected) {
            console.log('Disconnecting WebSocket...');

            var leaveMessage = {
                sender: username,
                type: 'LEAVE'
            };

            try {
                stompClient.send("/app/chat.addUser", {}, JSON.stringify(leaveMessage));
                console.log('Leave message sent');
            } catch (e) {
                console.log('Could not send leave message:', e);
            }

            stompClient.disconnect(function() {
                console.log('WebSocket disconnected');
            });
        }

        localStorage.removeItem('chat-username');
        localStorage.removeItem('chat-token');
        console.log('Local storage cleared');

        username = null;
        jwtToken = null;
        stompClient = null;

        chatPage.classList.add('hidden');
        usernamePage.classList.remove('hidden');

        messageArea.innerHTML = '';

        document.querySelector('#name').value = '';
        document.querySelector('#password').value = '';
        document.querySelector('#name').focus();

        console.log('Logout completed successfully');

        showLoginError('Logged out successfully!');
        setTimeout(() => {
            if (loginError) loginError.style.display = 'none';
        }, 3000);

    } catch (error) {
        console.error('Logout error:', error);
        alert('Logout failed: ' + error.message);
    }
}

    async function register(event) {
        event.preventDefault();

        var registerUsername = document.querySelector('#registerName').value.trim();
        var password = document.querySelector('#registerPassword').value.trim();
        var confirmPassword = document.querySelector('#confirmPassword').value.trim();

        console.log('Registration attempt:', {
            username: registerUsername,
            passwordLength: password.length,
            confirmPasswordLength: confirmPassword.length
        });

        // Validation
        if (!registerUsername || !password || !confirmPassword) {
            showRegisterError('Please fill all fields');
            return;
        }

        if (password !== confirmPassword) {
            showRegisterError('Passwords do not match');
            return;
        }

        if (password.length < 3) {
            showRegisterError('Password must be at least 3 characters long');
            return;
        }

        try {
            console.log('Sending registration request to:', BACKEND_URL + '/api/auth/register');

            const response = await fetch(BACKEND_URL + '/api/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: registerUsername,
                    password: password
                })
            });

            console.log('Registration response status:', response.status);

            const responseText = await response.text();
            console.log('Registration response body:', responseText);

            if (!response.ok) {
                throw new Error(responseText || 'Registration failed with status: ' + response.status);
            }

            const data = JSON.parse(responseText);
            console.log('Registration successful:', data);

            showRegisterSuccess('Registration successful! Please login.');

            // Clear form
            document.querySelector('#registerName').value = '';
            document.querySelector('#registerPassword').value = '';
            document.querySelector('#confirmPassword').value = '';

            // Switch to login form after 2 seconds
            setTimeout(() => {
                registerForm.style.display = 'none';
                usernameForm.style.display = 'block';
                document.querySelector('#name').value = registerUsername;
                document.querySelector('#password').focus();
            }, 2000);

        } catch (error) {
            console.error('Registration error:', error);
            showRegisterError('Registration failed: ' + error.message);
        }
    }

    function showRegisterError(message) {
        registerError.textContent = message;
        registerError.style.display = 'block';
        registerSuccess.style.display = 'none';

        setTimeout(function() {
            registerError.style.display = 'none';
        }, 5000);
    }

    function showRegisterSuccess(message) {
        registerSuccess.textContent = message;
        registerSuccess.style.display = 'block';
        registerError.style.display = 'none';

        setTimeout(function() {
            registerSuccess.style.display = 'none';
        }, 5000);
    }

    function showLoginError(message) {
        loginError.textContent = message;
        loginError.style.display = 'block';
        setTimeout(function() {
            loginError.style.display = 'none';
        }, 5000);
    }

    function onConnected() {
        console.log('WebSocket connected for user: ' + username);

        stompClient.subscribe('/topic/public', onMessageReceived);

        var joinMessage = {
            sender: username,
            type: 'JOIN'
        }

        stompClient.send("/app/chat.addUser",
            {},
            JSON.stringify(joinMessage)
        );

        connectingElement.classList.add('hidden');
    }

    function onError(error) {
        console.error('WebSocket error:', error);
        connectingElement.textContent = 'Could not connect to WebSocket server. Please refresh this page to try again!';
        connectingElement.style.color = 'red';
    }

    function sendMessage(event) {
        event.preventDefault();

        var messageContent = messageInput.value.trim();

        if (messageContent && stompClient && username) {
            var chatMessage = {
                sender: username,
                content: messageContent,
                type: 'CHAT'
            };

            console.log('Sending chat message: ', chatMessage);

            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        } else {
            console.error('Cannot send message. Check:', {
                hasContent: !!messageContent,
                hasStompClient: !!stompClient,
                hasUsername: !!username,
                stompClientConnected: stompClient ? stompClient.connected : false
            });
        }
    }

    function onMessageReceived(payload) {
    var message = JSON.parse(payload.body);
    var messageElement = document.createElement('li');

    if (message.type === 'JOIN') {
        messageElement.classList.add('event-message');
        messageElement.textContent = message.sender + ' joined!';
    } else if (message.type === 'LEAVE') {
        messageElement.classList.add('event-message');
        messageElement.textContent = message.sender + ' left!';
    } else {
        messageElement.classList.add('chat-message');

        var header = document.createElement('div');
        header.classList.add('message-header');

        var avatarElement = document.createElement('div');
        avatarElement.classList.add('avatar');

        var sender = message.sender || 'Unknown';
        avatarElement.textContent = sender.charAt(0).toUpperCase();
        avatarElement.style.backgroundColor = getAvatarColor(sender);

        var usernameElement = document.createElement('span');
        usernameElement.classList.add('username');
        usernameElement.textContent = message.sender;

        header.appendChild(avatarElement);
        header.appendChild(usernameElement);

        var textElement = document.createElement('div');
        textElement.classList.add('text');
        textElement.textContent = message.content || '';

        messageElement.appendChild(header);
        messageElement.appendChild(textElement);
    }

    messageArea.appendChild(messageElement);
    messageArea.scrollTop = messageArea.scrollHeight;
}

    function getAvatarColor(messageSender) {
        var hash = 0;
        for (var i = 0; i < messageSender.length; i++) {
            hash = 31 * hash + messageSender.charCodeAt(i);
        }
        var index = Math.abs(hash % colors.length);
        return colors[index];
    }

    // Event listeners
    usernameForm.addEventListener('submit', connect, true);
    registerForm.addEventListener('submit', register, true);
    messageForm.addEventListener('submit', sendMessage, true);

    document.addEventListener('click', function(event){
        if(event.target && event.target.id === 'logoutBtn'){
            console.log('Logout button clicked');
            event.preventDefault();
            logout();
        }
    });
</script>

<!-- External libraries -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</body>
</html>